name: .NET Core

on:
  push:
    branches: [ 'master' ]

env:
  TRIBUTECH_FEED: https://pkgs.dev.azure.com/tributechsolutions/Tributech%20DataSpace%20Kit/_packaging/tributech-dsk/nuget/v3/index.json
  BUILD_CONFIGURATION: 'Release'    # set this to the appropriate build configuration
  DOTNET_VERSION: '6.x' 

jobs:
  publish:
    name: build, pack & publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2    
    name: Nuget
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: ${{ env.TRIBUTECH_FEED }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.NUGET_PAT }} 
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.7
        with:
          versionSpec: '5.x'
      - name: Determine GitVersion
        uses: gittools/actions/gitversion/execute@v0.9.7
        with:
          useConfigFile: true
          configFilePath: 'GitVersion.yml'
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.0.5
      - name: Build Nuget DskApiClient
        run: dotnet build -p:Version=${{env.GitVersion_NuGetVersionV2}} -c ${{ env.BUILD_CONFIGURATION }} client/netcore/Tributech.Dsk.Api.Clients.csproj
      - name: Push Nuget Package
        run: dotnet nuget push **/*.nupkg -k ${{secrets.NUGET_API_KEY}} -s https://api.nuget.org/v3/index.json --skip-duplicate 
